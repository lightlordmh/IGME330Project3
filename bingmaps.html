<!DOCTYPE html>

<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Gas Station Finder</title>
	<style>
		h1 {
			margin-bottom: 5px;
			margin-top: 5px;
			position: absolute;
			top: 10px;
		}
		#Content {
			margin-bottom: 2px;
			z-index: 1;
		}
		
		#search {
			display: inline;

		}
		
		#zoomDrop {
			display: block;
			margin-bottom: 5px;
		}
		#myMap{
			z-index: 0;
		}
	</style>
	<script>
		window.onload = init;
		
		//Attributes
		var map;
		var navigationBarMode;
		var locBox;
		var zoomSet;
		var GAS_URL = "http://api.mygasfeed.com/stations/radius/";
		var GAS_API_KEY = "7ghfjf56rn";
		var dist;
		var gastype;
		var longitude;
		var latitude;

		//initialize the script
		function init(){
			//set default values for GUI elements
			locBox = "Rochester";
			dist = 5;
			gastype = "reg";
			//load the map 
			loadMapScenario();
			//attach events to GUI elements
			document.querySelector("#search").onclick = getData;
			//document.querySelector("#search").onmouseup = updateLoc();
			document.querySelector("#zoomChooser").onchange = changeZoom;
			document.querySelector("#gastypeChooser").onchange = changeGas;
			//set up local storage system
			if (localStorage.getItem("lastplace")){
				document.querySelector("#searchterm").value = localStorage.getItem("lastplace");
				if (localStorage.getItem("lastlat") && localStorage.getItem("lastlong")){
				console.log("Set new center!");
				map.setView({
					center: new Microsoft.Maps.Location(localStorage.getItem("lastlat"), localStorage.getItem("lastlong")),
					zoom: 7
				})}
			}
			if (localStorage.getItem("lastdist")){
				document.querySelector("#searchterm2").value = localStorage.getItem("lastdist");
			}
			//get the center of the map and update map position 
			var ctr = map.getCenter();
			latitude = map.getCenter().latitude;
			longitude = map.getCenter().longitude;
<<<<<<< HEAD
			//document.onclick = updateLoc;
		}
		
		function updateLoc(lat, lon){
			latitude = lat;
			longitude = lon;
=======
			document.onclick = updateLoc();
		}
		//Updates the global latitude and longitude values
		function updateLoc(){
			latitude = map.getCenter().latitude;
			longitude = map.getCenter().longitude;
>>>>>>> 6fd81421ef8364f4d96408b21172da9cf4104867
			localStorage.setItem("lastlat",  latitude);
			localStorage.setItem("lastlong",  longitude);
			printInfo();
		}
		//updates the gastype Global value
		function changeGas(){
			gastype = document.querySelector("#gastypeChooser").value;
			console.log(gastype);
		}
		//updates the zoomSet Global value and updates the zoom level of the map
		function changeZoom(){
			zoomSet = document.querySelector("#zoomChooser").value;
			console.log(zoomSet);
			map.setView({
				zoom: parseInt(zoomSet)
			});
		}
		//Main logic function
		//handles map updates, gets gas station information, and adds pins to the map
		function getData(){
<<<<<<< HEAD
			value = document.querySelector("#searchterm").value;
			value = value.trim();
			if(value.length < 1) return;
			//console.log(value);
			dist = document.querySelector("#searchterm2").value;
			Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
				var searchManager = new Microsoft.Maps.Search.SearchManager(map);
				var requestOptions = {
					bounds: map.getBounds(),
					where: value,
					callback: function (answer, userData) {
						map.setView({ bounds: answer.results[0].bestView });
						updateLoc(answer.results[0].location.latitude, answer.results[0].location.longitude);
						//map.entities.push(new Microsoft.Maps.Pushpin(answer.results[0].location));
					}
				};
				searchManager.geocode(requestOptions);
				if (isNaN(dist) || parseInt(dist) < 0){
					return;
				}
				dist = dist.trim();
				if(dist.length < 1) return;
				console.log(dist);
				/*latitude = map.getCenter().latitude;
				longitude = map.getCenter().longitude;*/
				localStorage.setItem("lastplace", value);
				localStorage.setItem("lastdist", dist);
			});
=======
			//clear the map and pushpins
>>>>>>> 6fd81421ef8364f4d96408b21172da9cf4104867
			map.entities.clear();
			var pushpins = [];
			//main logic for getting the
			var xhr = new XMLHttpRequest();
			xhr.onload = function(){

				// JSON.parse() converts a string to JSON.
 				var myJSON = JSON.parse( xhr.responseText );
				var gasStations = myJSON.stations;
				//loop through the array of gas station
				for(var i=0;i<gasStations.length;i++){
					//get a gas station in the list
					var station = gasStations[i];
					//create a new pushpin at the station's location and add that to the list of pushpins
					var pushpin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(station.lat,station.lng));
					pushpins.push(pushpin);
				}
				//setup the info box 
				var infobox = new Microsoft.Maps.Infobox(pushpins[0].getLocation(), { visible: false });
				infobox.setMap(map);
				//loop through the pushpins and add infobox to them along with associated station data
				for (var i = 0; i < pushpins.length; i++) {
					//get a pushpin and station from their lists
					var pushpin = pushpins[i];
					var station = gasStations[i];
					//based on gas type set the type and price to add to the pushpin
					var gasPhrase;
					var gasPrice;
					switch(gastype){
						case "reg":
							gasPhrase = "<br>Regular Price: $";
							gasPrice = station.reg_price;
						break;
						case "med":
							gasPhrase = "<br>Medium Price: $";
							gasPrice = station.mid_price;
						break;
						case "pre":
							gasPhrase = "<br>Premium Price: $";
							gasPrice = station.pre_price;
						break;
						case "diesel":
							gasPhrase = "<br>Diesel Price: $";
							gasPrice = station.diesel_price;
						break;
					}
					//Store some metadata with the pushpin
					pushpin.metadata = {
						title: station.station,
						description: "Address: " + station.address + "<br> Distance: " + station.distance + gasPhrase + gasPrice 
					};
					//attach an event to the pushpin and add accociated data
					Microsoft.Maps.Events.addHandler(pushpin, 'click', function (args) {
						infobox.setOptions({
							location: args.target.getLocation(),
							title: args.target.metadata.title,
							description: args.target.metadata.description,
							visible: true
						});
					});
				}
				//add all pushpins to the map
				map.entities.push(pushpins);
			}

<<<<<<< HEAD

=======
			//get the search term and check if the box has data in it
			locBox = document.querySelector("#searchterm").value;
			locBox = locBox.trim();
			if(locBox.length < 1) return;
			//console.log(value);
			//set the distance radius to search
			dist = document.querySelector("#searchterm2").value;
			//setup the map and load it
			Microsoft.Maps.loadModule('Microsoft.Maps.Search', function () {
				var searchManager = new Microsoft.Maps.Search.SearchManager(map);
				var requestOptions = {
					bounds: map.getBounds(),
					where: locBox,
					callback: function (answer, userData) {
						map.setView({ bounds: answer.results[0].bestView });
						//map.entities.push(new Microsoft.Maps.Pushpin(answer.results[0].location));
					}
				};
				searchManager.geocode(requestOptions);
				if (isNaN(dist) || parseInt(dist) < 0){
					return;
				}
				dist = dist.trim();
				if(dist.length < 1) return;
				console.log(dist);
				//set the global latitude and longitude
				latitude = map.getCenter().latitude;
				longitude = map.getCenter().longitude;
				localStorage.setItem("lastplace", locBox);
				localStorage.setItem("lastdist", dist);
				updateLoc();
			});
			//build url, open a connection to API, send info and run logic
>>>>>>> 6fd81421ef8364f4d96408b21172da9cf4104867
			var url = GAS_URL + latitude  +"/"+ longitude +"/"+ dist +"/"+ gastype +"/distance/" + GAS_API_KEY + ".json";
			console.log(url);
			xhr.open('GET',url,true);
			xhr.send();

		}
		//load the map from the API
		function loadMapScenario() {
			navigationBarMode = Microsoft.Maps.NavigationBarMode;
			map = new Microsoft.Maps.Map(document.getElementById('myMap'), {
				credentials: 'y7SZBP21wKo65lBDPlws~HAiXZ226YEBQTxYMbCKUCw~AgYdjoumaTtW8ZZH-xz2x16G5PXiGttwQgZT6glN1rjBILJVUJ02wR6b4pL9-4fu',
				navigationBarMode: navigationBarMode.compact
			});
		}
		//Debug Function 
		function printInfo(){
            console.log('Map center: ' + map.getCenter());
            //console.log('Map bounds: ' + map.getBounds());
            //console.log('Map type id: ' + map.getMapTypeId());
            //console.log('Map zoom level: ' + map.getZoom());
			console.log('Map latitude: ' +latitude);
			console.log('Map longitude: ' +longitude);
			console.log(localStorage.getItem("lastplace"));
			console.log(localStorage.getItem("lastdist"));
			console.log(localStorage.getItem("lastlat"));
			console.log(localStorage.getItem("lastlong"));
		}
	</script>
	<script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=loadMapScenario' async defer></script>
</head>

<body>
	<div id='printoutPanel'></div>
	<div id='myMap' style='width: 99vw; height: 84.8vh;'></div>
	<div id="Content"><h1>Gas Station Finder</h1>
		Around what location? <input id="searchterm" type="text" size="20" maxlength="30" autofocus value="Rochester" /> 
		Within how many miles? <input id="searchterm2" type="text" size="5" maxlength="10" autofocus value="5" /> 
		<div id="gastypeDrop" class="dropdown-content">
			<label>Gas Type:
				<select id="gastypeChooser">
					<option value="reg">Regular</option>
					<option value="mid">MID</option>
					<option value="pre">PRE</option>
					<option value="diesel">Diesel</option>
				</select>
			</label>
		</div>
			<button type="button" id="search">Get Gas<br /></button>
	</div>
	<div class="dropdown">
  	<div id="zoomDrop" class="dropdown-content">
		<label>Zoom Level:
			<select id="zoomChooser">
				<option value="20">20</option>
				<option value="15">15</option>
				<option value="10">10</option>
				<option value="5">5</option>
    		</select>
    	</label>
	</div>
</body>

</html>